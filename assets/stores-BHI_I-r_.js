import{a9 as S,aa as g,ab as M,i as w,a4 as b,a5 as E}from"./vendor-Ccy1iyrD.js";import{b as m,S as C,k as P,c as I,e as $,B as N,C as O}from"./utils-DKI4o8xi.js";import{r as x,t as v,s as W,u as G}from"./components-BOV_PMtb.js";const A=S("home",{state:()=>({userInfo:{isLoggedIn:!1,username:"",id:"",avatar:"user"},totalBlueprints:0,totalUsers:0,totalViews:0,totalDownloads:0,hotBlueprints:[],allBlueprints:[],discoverBlueprints:[],userBlueprintsPage:1,userBlueprintsLimit:10,userBlueprintsTotal:0,searchQuery:"",selectedArea:"",currentPage:1,pageSize:12,total:0,codeCountdown:0,sendCodeLoading:!1,loading:{stats:!1,blueprints:!1,discover:!1,user:!1},error:null}),actions:{setUserInfo(t){this.userInfo={isLoggedIn:!0,username:t.nickname||"",id:t.id||"",avatar:t.avatar||"user",role:"user"}},async register(t){try{return this.loading.user=!0,await m.register(t)}catch(e){throw this.error=e.message||"注册失败",e}finally{this.loading.user=!1}},async sendVerificationCode(t){try{if(!t)throw new Error("请输入邮箱");return this.sendCodeLoading=!0,this.error=null,await m.sendVerificationCode({email:t}),this.codeCountdown=60,this.startCountdown(),{success:!0,message:"验证码已发送，请查收"}}catch(e){throw this.error=e.message||"发送验证码失败",e}finally{this.sendCodeLoading=!1}},startCountdown(){this.countdownTimer&&clearInterval(this.countdownTimer),this.countdownTimer=setInterval(()=>{this.codeCountdown>0?this.codeCountdown--:(clearInterval(this.countdownTimer),this.countdownTimer=null)},1e3)},clearCountdown(){this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null,this.codeCountdown=0)},clearUserInfo(){this.userInfo={isLoggedIn:!1,username:"",id:"",avatar:"user"}},checkLoginStatus(){const t=localStorage.getItem("token");t&&(m.setToken(t),this.loadUserInfo())},async loadUserInfo(){try{this.loading.user=!0;const t=await m.getUserInfo();this.setUserInfo(t.data||{})}catch(t){console.error("加载用户信息失败:",t),localStorage.removeItem("token"),m.setToken(null),this.clearUserInfo()}finally{this.loading.user=!1}},async login(t){try{this.loading.user=!0;const e=await m.login(t);if(e.data.token)return m.setToken(e.data.token),localStorage.setItem("token",e.data.token),this.setUserInfo(e.data.user||{}),e.data}catch(e){throw this.error=e.message||"登录失败",e}finally{this.loading.user=!1}},logout(){m.setToken(null),localStorage.removeItem("token"),this.clearUserInfo()},async loadStats(){try{this.loading.stats=!0;const e=(await m.getHomepageData()).data||{};this.totalBlueprints=e.totalBlueprints||0,this.totalUsers=e.totalUsers||0,this.totalViews=e.totalViews||0,this.totalDownloads=e.totalDownloads||0,this.hotBlueprints=Array.isArray(e.hotBlueprints)?e.hotBlueprints.slice(0,7):[]}catch(t){this.error=t.message||"加载统计数据失败",console.error("加载统计数据失败:",t)}finally{this.loading.stats=!1}},async loadBlueprints(t={}){try{this.loading.blueprints=!0;const e=await m.getUserBlueprints({sortBy:t.sortBy||"createdAt",sortOrder:t.sortOrder||"desc",page:t.page||this.userBlueprintsPage,limit:t.limit||this.userBlueprintsLimit});this.allBlueprints=Array.isArray(e.data?.items)?e.data.items:[],this.userBlueprintsTotal=e.data?.total||0,this.userBlueprintsPage=e.data?.page||1,this.userBlueprintsLimit=e.data?.limit||10,this.hotBlueprints=[...this.allBlueprints].sort((i,s)=>(s.views||0)-(i.views||0)).slice(0,3),this.totalBlueprints=this.allBlueprints.length,this.totalViews=Array.isArray(this.allBlueprints)?this.allBlueprints.reduce((i,s)=>i+(s.views||0),0):0,this.totalDownloads=Array.isArray(this.allBlueprints)?this.allBlueprints.reduce((i,s)=>i+(s.downloads||0),0):0}catch(e){this.error=e.message||"加载蓝图失败",this.allBlueprints=[],this.userBlueprintsTotal=0}finally{this.loading.blueprints=!1}},async refreshData(){await Promise.all([this.loadStats(),this.loadBlueprints()])},async loadDiscoverBlueprints(t=1,e={}){try{this.loading.discover=!0,this.error=null;const i={search:e.search||this.searchQuery,area:e.area||this.selectedArea,sortBy:"views",sortOrder:"desc",page:t,limit:e.limit||this.pageSize},s=await m.searchBlueprints(i);this.discoverBlueprints=Array.isArray(s.data?.items)?s.data.items:[],this.total=s.data?.total||0,this.currentPage=t,this.searchQuery=e.search||this.searchQuery,this.selectedArea=e.area||this.selectedArea}catch(i){this.error=i.message||"加载蓝图失败",console.error("加载发现页面蓝图失败:",i),this.discoverBlueprints=[],this.total=0}finally{this.loading.discover=!1}},setSearchFilters(t){t.search!==void 0&&(this.searchQuery=t.search),t.area!==void 0&&(this.selectedArea=t.area),t.page!==void 0&&(this.currentPage=t.page),t.pageSize!==void 0&&(this.pageSize=t.pageSize)},async getBlueprintById(t){return await m.getBlueprintById(t)}}}),R=S("sheng-select-store",{state:()=>({rootStore:k(),selector:null,startX:null,startY:null,isStartSelect:!1,canSelect:!1,midDeleteData:null}),actions:{initSelector(t){this.selector=t},enableSelect(){this.canSelect=!0},disableSelect(){this.canSelect=!1},showSelector(){this.selector.style.opacity=1},hideSelector(){this.selector.style.opacity=0},confirmDelete(){this.rootStore.quickPlaceMode==="pipe"?this.rootStore.deleteSeriesPipe2d(this.midDeleteData):this.rootStore.deleteSeriesBelt2d(this.midDeleteData),this.hideSelectorAMenu()},handleSelectOver(){this.hideSelector(),this.isStartSelect=!1,this.selector.style.width="0px",this.selector.style.height="0px"},handleMouseDown(t){this.rootStore.toolbarMode=="select"&&this.canSelect&&(this.setPosition(t),this.showSelector(),this.isStartSelect=!0)},handleMouseMove(t){if(this.rootStore.toolbarMode!="select"||!this.isStartSelect)return;let e=Math.abs(this.startX-t.clientX),i=Math.abs(this.startY-t.clientY);this.selector.style.width=`${e}px`,this.selector.style.height=`${i}px`},handleMouseUp(t){if(this.rootStore.toolbarMode!="select"||!this.canSelect)return;let e=Math.abs(this.startX-t.clientX),i=Math.abs(this.startY-t.clientY)/2;this.endX=this.startX+e,this.endY=this.startY+i;const s={startCell:this.rootStore.getPositionFromClick({clientX:this.startX,clientY:this.startY}),endCell:this.rootStore.getPositionFromClick({clientX:this.startX+e,clientY:this.endY+i})};C.updateIndicatorContent(s),this.handleSelectOver()},setPosition(t){this.startX=t.clientX,this.startY=t.clientY,this.selector.style.top=`${t.clientY}px`,this.selector.style.left=`${t.clientX}px`}}}),k=S("sheng-root-store",{state:()=>({host:"https://api.t2blueprint.xyz",appContext:null,isBluePrintImport:!1,isRecipeChoose:!1,isWareHouseRecipeChoose:!1,isZomming:!1,isShowSupplierExtent:!1,isShowMachines:!0,isShowBelts:!0,isShowPipes:!0,isShowPipePort:!0,quickPlaceMode:"belt",keyboardCommand:null,selectSubMode:null,recipeChooseId:"",materialChooseId:"",toolbarMode:"default",beltSelect:"turn",editPartChoose:"part0",gridWidgetElements:g({}),gridWidgets:{},gridBelt2dElement:g({}),gridBelts2d:null,gridPipe2dElement:g({}),gridPipes2d:null,partsWidgetId:{part0:new Set},partsBelts:{part0:new Set},partsPipes:{part0:new Set},parts:[{name:"part0",code:"",show:!0}],rootGrid:null,gridEl:null,gridElCont:null,overlay:null,pipeGrid:null,rootPipeGrid:null,gridElContScale:1,defaultWidth:3017,defaultHeight:3017,defaultMaxWidth:3017,defaultMinWidth:1578,numColumn:72,gridOptions:{minRow:72,allowNewRow:!1,float:!0,acceptWidgets:function(t){return!0}},gridPipeOptions:{minRow:72,allowNewRow:!1,float:!0,acceptWidgets:function(t){return!1}},lastBaseNode:null,lastDir:null}),actions:{initGrid(t,e,i,s){this.initBelts2d(),this.appContext=s,this.gridEl=g(t),this.gridElCont=g(e),this.overlay=g(i),this.rootGrid=g(E.init(this.gridOptions,t)),this.rootGrid.column(this.numColumn),this.gridEl.style.width=`${this.defaultWidth}px`,this.gridEl.style.height=`${this.defaultHeight}px`,this.gridElContScale=1,P.init(this.gridElCont),P.updateScale(this.gridElContScale),$.init(this.gridElCont),N.init(this.overlay),C.init(this.overlay),O.init()},initPipeGrid(t){this.pipeGrid=g(t),this.rootPipeGrid=g(E.init(this.gridPipeOptions,t)),this.rootPipeGrid.column(this.numColumn),this.pipeGrid.style.width=`${this.defaultWidth}px`,this.pipeGrid.style.height=`${this.defaultHeight}px`,this.gridPipes2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({})))},getPositionFromClick(t){let e=t.clientX,i=t.clientY;return this.rootGrid.getCellFromPixel({left:e,top:i},!0)},isCellEmpty(t){const{x:e,y:i}=this.getPositionFromClick(t);return this.isCellEmptyByPosition(e,i)},isCellEmptyByPosition(t,e){return this.rootGrid.isAreaEmpty(t,e,1,1)},isCellEmptyPipe(t){const{x:e,y:i}=this.getPositionFromClick(t);return this.isCellEmptyForPipe(e,i)},isCellEmptyForPipe(t,e){let i=this.rootGrid.isAreaEmpty(t,e,1,1),s=Object.keys(this.gridBelts2d[t][e]).length===0,r=Object.keys(this.gridPipes2d[t][e]).length===0;if(!r||!i&&s)return!1;if(!i&&!s||r)return!0},handleScalingChange_(t){if(t.preventDefault(),t.stopPropagation(),this.toolbarMode==="select"||this.isRecipeChoose)return;this.isZomming||(this.isZomming=!0,this.rootGrid.setStatic(!0));const e=-t.deltaY*5e-4;this.gridElContScale=Math.max(.35,Math.min(2,this.gridElContScale+e)),P.updateScale(this.gridElContScale),this.gridEl.style.transform=`scale(${this.gridElContScale}) translate(100px, 100px)`,this.overlay.style.transform=`scale(${this.gridElContScale}) translate(100px, 100px)`,this.pipeGrid.style.transform=`scale(${this.gridElContScale}) translate(100px, 100px)`,clearTimeout(this._zoomEndTimer),this._zoomEndTimer=setTimeout(()=>{this.isZomming=!1,this.rootGrid.setStatic(!1)},120)},initBelts2d(){this.gridBelts2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({})))},deleteOneBelt(t){const e=this.gridBelt2dElement[`${t.x}-${t.y}`];if(e){this.rootGrid.removeWidget(e);let i=this.gridBelts2d[t.x][t.y].part;this.partsBelts[i].delete(`${t.x}-${t.y}`),this.gridBelts2d[t.x][t.y]={},delete this.gridBelt2dElement[`${t.x}-${t.y}`]}},deleteOnePipe(t){const e=this.gridPipe2dElement[`${t.x}-${t.y}`];if(e){this.rootPipeGrid.removeWidget(e);let i=this.gridPipes2d[t.x][t.y].part;this.partsPipes[i].delete(`${t.x}-${t.y}`),this.gridPipes2d[t.x][t.y]={},delete this.gridPipe2dElement[`${t.x}-${t.y}`]}},deleteSeriesBelt2d(t){const{startX:e,startY:i,endX:s,endY:r}=t,o=this.getPositionFromClick({clientX:e,clientY:i}),d=this.getPositionFromClick({clientX:s,clientY:r}),p=Math.min(o.x,d.x),c=Math.max(o.x,d.x),a=Math.min(o.y,d.y),n=Math.max(o.y,d.y);for(let l=p;l<=c;l++)if(!(l<0||l>=this.gridOptions.minRow))for(let h=a;h<=n;h++){if(h<0||h>=this.numColumn)continue;const u={x:l,y:h};this.deleteOneBelt(u)}},deleteSeriesPipe2d(t){const{startX:e,startY:i,endX:s,endY:r}=t,o=this.getPositionFromClick({clientX:e,clientY:i}),d=this.getPositionFromClick({clientX:s,clientY:r}),p=Math.min(o.x,d.x),c=Math.max(o.x,d.x),a=Math.min(o.y,d.y),n=Math.max(o.y,d.y);for(let l=p;l<=c;l++)if(!(l<0||l>=this.gridOptions.minRow))for(let h=a;h<=n;h++){if(h<0||h>=this.numColumn)continue;const u={x:l,y:h};this.deleteOnePipe(u)}},generateOneBelt(t,e="belt-img",i=0,s=null){let r=document.createElement("div"),o=s||`${s}_${Date.now()}_${Math.floor(Math.random()*1e3)}`,d=w(G,{gs_id:o,rotate:i,type:e,position:t});b(d,r),r=this.rootGrid.makeWidget(r,{x:t.x,y:t.y,w:1,h:1,float:!1,noResize:!0,locked:!0,id:o}),this.rootGrid.movable(r,!1),this.partsBelts[this.editPartChoose].add(`${t.x}-${t.y}`),this.gridBelt2dElement[`${t.x}-${t.y}`]=r,this.gridBelts2d[t.x][t.y]={rotate:i,type:e,id:o,part:this.editPartChoose}},generateOnePipe(t,e="belt-img-pipe",i=0,s=null){let r=document.createElement("div"),o=s||`${s}_${Date.now()}_${Math.floor(Math.random()*1e3)}`,d=w(W,{gs_id:o,rotate:i,type:e,position:t});b(d,r),r=this.rootPipeGrid.makeWidget(r,{x:t.x,y:t.y,w:1,h:1,float:!1,noResize:!0,locked:!0,id:o}),this.rootPipeGrid.movable(r,!1),this.partsPipes[this.editPartChoose].add(`${t.x}-${t.y}`),this.gridPipe2dElement[`${t.x}-${t.y}`]=r,this.gridPipes2d[t.x][t.y]={rotate:i,type:e,id:o,part:this.editPartChoose}},replacePipeNodeAtPosition(t,{type:e,rotate:i},s="pipe"){const r=this.gridPipe2dElement[`${t.x}-${t.y}`];r&&(this.rootPipeGrid.removeWidget(r,!0),this.gridPipes2d[t.x][t.y]={},this.generateOnePipe(t,e,i,s))},replaceNodeAtPosition(t,{type:e,rotate:i},s="belt"){const r=this.gridBelt2dElement[`${t.x}-${t.y}`];r&&(this.rootGrid.removeWidget(r,!0),this.gridBelts2d[t.x][t.y]={},this.generateOneBelt(t,e,i,s))},getStraightRotateIndex(t,e){if(t===1&&e===0)return 0;if(t===0&&e===1)return 1;if(t===-1&&e===0)return 2;if(t===0&&e===-1)return 3},getTurnRotateIndex(t,e){return{"0-3":0,"0-1":3,"1-1":3,"1-2":0,"1-0":1,"3-0":2,"3-2":3,"2-3":1,"2-1":2}[`${t}-${e}`]},generateStraightPipe(t,e,i="pipe"){const s=e.x-t.x,r=e.y-t.y;if(s!==0&&r!==0)return!1;const o=s===0?0:s>0?1:-1,d=r===0?0:r>0?1:-1,p=Math.abs(s+r),c=this.getStraightRotateIndex(o,d);if(this.lastDir!==null&&this.lastDir!==c){const a=this.getTurnRotateIndex(this.lastDir,c);if(a===void 0)return!1;this.replacePipeNodeAtPosition(t,{type:"turn-img-pipe",rotate:a})}for(let a=1;a<=p;a++){const n=t.x+o*a,l=t.y+d*a;if(!this.isCellEmptyForPipe(n,l))return!1}for(let a=1;a<=p;a++){const n=t.x+o*a,l=t.y+d*a;this.generateOnePipe({x:n,y:l},"belt-img-pipe",c,i)}return this.lastDir=c,!0},generateStraightBelt(t,e,i="belt"){const s=e.x-t.x,r=e.y-t.y;if(s!==0&&r!==0)return!1;const o=s===0?0:s>0?1:-1,d=r===0?0:r>0?1:-1,p=Math.abs(s+r),c=this.getStraightRotateIndex(o,d);if(this.lastDir!==null&&this.lastDir!==c){const a=this.getTurnRotateIndex(this.lastDir,c);if(a===void 0)return!1;this.replaceNodeAtPosition(t,{type:"turn-img",rotate:a})}for(let a=1;a<=p;a++){const n=t.x+o*a,l=t.y+d*a;if(!this.isCellEmptyByPosition(n,l))return!1}for(let a=1;a<=p;a++){const n=t.x+o*a,l=t.y+d*a;this.generateOneBelt({x:n,y:l},"belt-img",c,i)}return this.lastDir=c,!0},generateBelt(t,e="belt"){if(!this.lastBaseNode){this.lastBaseNode={...t},this.lastDir=null;return}const i={...this.lastBaseNode},s={x:t.x,y:i.y};s.x!==i.x&&!this.generateStraightBelt(i,s)||t.y!==s.y&&!this.generateStraightBelt(s,t)||(this.lastBaseNode={...t})},generatePipe(t,e="pipe"){if(!this.lastBaseNode){this.lastBaseNode={...t},this.lastDir=null;return}const i={...this.lastBaseNode},s={x:t.x,y:i.y};s.x!==i.x&&!this.generateStraightPipe(i,s)||t.y!==s.y&&!this.generateStraightPipe(s,t)||(this.lastBaseNode={...t})},handleClickBelts(t){const e=this.getPositionFromClick(t);this.quickPlaceMode==="belt"&&(this.isCellEmpty(t)||t.isBeltPort)&&this.generateBelt(e,"belt"),this.quickPlaceMode==="pipe"&&this.isCellEmptyPipe(t)&&this.generatePipe(e,"pipe")},handleClickSingleBoP(t){const e=this.getPositionFromClick(t);if(this.quickPlaceMode==="pipe"&&["belt","turn"].includes(this.toolbarMode)&&this.isCellEmptyPipe(t)){let i=`${this.toolbarMode}-img-pipe`;this.generateOnePipe(e,i,0,this.toolbarMode);return}if(this.quickPlaceMode==="pipe"&&!["belt","turn"].includes(this.toolbarMode)&&this.isCellEmpty(t)){let i=`${this.toolbarMode}-img-pipe`;this.generateOneBelt(e,i,0,this.toolbarMode);return}if(this.quickPlaceMode==="belt"&&this.isCellEmpty(t)){let i=`${this.toolbarMode}-img`;this.generateOneBelt(e,i,0,this.toolbarMode);return}},handleDialogRecipeClose(){this.rootGrid.enableMove(!0)},handleOverlayClick(t,e={}){const i=new MouseEvent("click",{clientX:t.clientX,clientY:t.clientY,bubbles:!0,cancelable:!0}),s=Object.assign(i,e);this.quickPlaceMode==="belt"&&this.gridEl.dispatchEvent(s),this.quickPlaceMode==="pipe"&&this.pipeGrid.dispatchEvent(s)},makeMachine(t){const{id:e,machine_id:i,recipe:s,rotate:r,x:o,y:d,w:p,h:c,part:a}=t,n=w(I[i],{gs_id:e,el_name:i,el_size:{w:p,h:c},rotate:r});this.gridWidgets[e]={rotate:r,recipe:s,part:a};const l=document.createElement("div");b(n,l),this.gridWidgetElements[e]=this.rootGrid.makeWidget(l,{x:o,y:d,w:p,h:c,noResize:!0,id:e})},checkNodesCanMove(t,e,i,s){const{biasX:r,biasY:o}=i;return Object.entries(e).every(([p,c])=>{const n=c.el.gridstackNode,l=n.x+r,h=n.y+o;return t.isAreaEmpty(l,h,n.w,n.h)})?!0:(v.error(s),!1)},batchMovePipe(t,e){const{biasX:i,biasY:s}=e,r=this.rootPipeGrid.engine;r.batchUpdate(!0,!0),r.float=!1;const o=[];return Object.entries(t).forEach(([d,p])=>{const c=p.el,a=c.gridstackNode,n=a.x,l=a.y,h=this.gridPipes2d[n][l];h&&(o.push({element:c,oldX:n,oldY:l,data:h}),this.gridPipes2d[n][l]={},delete this.gridPipe2dElement[`${n}-${l}`])}),o.forEach(({element:d,oldX:p,oldY:c,data:a})=>{const n=d.gridstackNode,l=n.x+i,h=n.y+s;this.rootPipeGrid.update(d,{x:l,y:h}),this.gridPipes2d[l][h]=a,this.gridPipe2dElement[`${l}-${h}`]=d;const u=a.part;u&&(this.partsPipes[u].delete(`${p}-${c}`),this.partsPipes[u].add(`${l}-${h}`))}),r.batchUpdate(!1,!0),r.float=!0,!0},batchMoveBelt(t,e){const{biasX:i,biasY:s}=e,r=this.rootGrid.engine;r.batchUpdate(!0,!0),r.float=!1;const o=[];return Object.entries(t).forEach(([d,p])=>{const c=p.el,a=c.gridstackNode,n=a.x,l=a.y,h=this.gridBelts2d[n][l];h&&(o.push({element:c,oldX:n,oldY:l,data:h}),this.gridBelts2d[n][l]={},delete this.gridBelt2dElement[`${n}-${l}`])}),o.forEach(({element:d,oldX:p,oldY:c,data:a})=>{const n=d.gridstackNode,l=n.x+i,h=n.y+s;this.rootGrid.update(d,{x:l,y:h}),this.gridBelts2d[l][h]=a,this.gridBelt2dElement[`${l}-${h}`]=d;const u=a.part;u&&(this.partsBelts[u].delete(`${p}-${c}`),this.partsBelts[u].add(`${l}-${h}`))}),r.batchUpdate(!1,!0),r.float=!0,!0},batchMoveMahcine(t,e){const{biasX:i,biasY:s}=e,r=this.rootGrid.engine;return r.batchUpdate(!0,!0),r.float=!1,Object.entries(t).reverse().forEach(([o,d])=>{const p=d.el,c=p.gridstackNode,a=c.x+i,n=c.y+s;this.rootGrid.update(p,{x:a,y:n})}),r.batchUpdate(!1,!0),r.float=!0,!0},batchMove(t,e){const{machineNodes:i,beltNodes:s,pipeNodes:r}=t,o=this.rootGrid.engine,d=this.rootPipeGrid.engine,p=this.checkNodesCanMove(o,i,e,"有机器位置冲突，无法移动"),c=this.checkNodesCanMove(o,s,e,"有传送带位置冲突，无法移动"),a=this.checkNodesCanMove(d,r,e,"有管道位置冲突，无法移动");return!p||!c||!a?!1:(this.batchMoveMahcine(i,e),this.batchMoveBelt(s,e),this.batchMovePipe(r,e),!0)},addNewPart(){const t={name:`part${this.parts.length}`,code:"",show:!0};this.partsBelts[t.name]=new Set,this.partsWidgetId[t.name]=new Set,this.partsPipes[t.name]=new Set,this.parts.push(t)},selectEditPart(t){this.editPartChoose=t},handlePartShowChange(t,e){this.showPartWidgets(t,e),console.log(t,e)},showPartWidgets(t,e){for(let i of this.partsWidgetId[t.name])this.gridWidgetElements[i].style.opacity=e?1:.2;for(let i of this.partsBelts[t.name])this.gridBelt2dElement[i].style.opacity=e?1:.2;for(let i of this.partsPipes[t.name])this.gridPipe2dElement[i].style.opacity=e?1:.2},deletePart(t){const e=this.parts[t];x.confirm("是否删除？模块中的机器和传送带会被并入part0","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消"}).then(i=>{if(i){for(let s of this.partsWidgetId[e.name])this.partsWidgetId.part0.add(s),this.gridWidgetElements[s].style.opacity=this.parts[0].show?1:.2;for(let s of this.partsBelts[e.name])this.partsBelts.part0.add(s),this.gridBelt2dElement[s].style.opacity=this.parts[0].show?1:.2;for(let s of this.partsPipes[e.name])this.partsPipes.part0.add(s),this.gridPipe2dElement[s].style.opacity=this.parts[0].show?1:.2;this.parts.splice(t,1),this.editPartChoose="part0"}})},copyEditCode(t){const e=this.parts[t];e&&(P.disable(),x.prompt("编辑模块代码","代码编辑",{confirmButtonText:"确定",cancelButtonText:"取消",defaultValue:e.code||""}).then(i=>{i!==null&&(this.parts[t].code=i)}).finally(()=>{P.enable()}))},handleBluePrintImportDialog(){this.isBluePrintImport=!0},handleBluePrintUpload(t){if(t.status!=="ready")return;const e=t.raw;if(!e||!e.name.endsWith(".json"))return;const i=new FileReader;i.onload=()=>{const s=JSON.parse(i.result);this.importBluePrint(s)},i.readAsText(e)},saveBluePrint(){let t={machine:null,belt:null,part:null},e=[],i=[],s=[],r={};const o=Object.entries(this.gridBelt2dElement),d=Object.entries(this.gridPipe2dElement),p=Object.entries(this.gridWidgetElements),c=Object.entries(this.gridWidgets);for(let a=0;a<p.length;a+=1){let[n,{rotate:l,recipe:h,part:u}]=c.at(a),[B,f]=p.at(a),y={id:n,machine_id:n.split("_")[0],recipe:h,rotate:l,x:f.gridstackNode.x,y:f.gridstackNode.y,w:f.gridstackNode.w,h:f.gridstackNode.h,part:u};e.push(y)}t.machine=e;for(let a=0;a<o.length;a+=1){let[n,l]=o.at(a),[h,u]=n.split("-"),{rotate:B,type:f}=this.gridBelts2d[Number(h)][Number(u)],y={id:l.gridstackNode.id,type:f,rotate:B,position:{x:Number(h),y:Number(u)}};i.push(y)}t.belt=i;for(let a=0;a<d.length;a+=1){let[n,l]=d.at(a),[h,u]=n.split("-"),{rotate:B,type:f}=this.gridPipes2d[Number(h)][Number(u)],y={id:l.gridstackNode.id,type:f,rotate:B,position:{x:Number(h),y:Number(u)}};s.push(y)}t.pipe=s,r.parts=this.parts,r.partsWidgetId={},r.partsBelts={},r.partsPipes={},r.editPartChoose=this.editPartChoose;for(let a of Object.keys(this.partsWidgetId)){let n=Array.from(this.partsWidgetId[a]),l=Array.from(this.partsBelts[a]),h=Array.from(this.partsPipes[a]);r.partsWidgetId[a]=n,r.partsBelts[a]=l,r.partsPipes[a]=h}return t.part=r,localStorage.removeItem("blueprint"),localStorage.blueprint=JSON.stringify(t),M.success({title:"成功",message:"蓝图保存成功"}),t},importBluePrint(t){let{machine:e,belt:i,part:s,pipe:r}=t;for(let o of e)this.makeMachine(o);for(let o of i)this.generateOneBelt(o.position,o.type,o.rotate,o.id);for(let o of r)this.generateOnePipe(o.position,o.type,o.rotate,o.id);if(s){if(this.parts=s.parts||[],this.partsWidgetId={},s.partsWidgetId)for(let o of Object.keys(s.partsWidgetId))this.partsWidgetId[o]=new Set(s.partsWidgetId[o]);if(this.partsBelts={},s.partsBelts)for(let o of Object.keys(s.partsBelts))this.partsBelts[o]=new Set(s.partsBelts[o]);if(this.partsPipes={},s.partsPipes)for(let o of Object.keys(s.partsPipes))this.partsPipes[o]=new Set(s.partsPipes[o]);this.editPartChoose=s.editPartChoose||"part0"}},exportBluePrint(t,e="blueprint.json"){t=this.saveBluePrint();try{const i=JSON.stringify(t,null),s=new Blob([i],{type:"application/json"}),r=URL.createObjectURL(s),o=document.createElement("a");o.href=r,o.download=e,o.click(),URL.revokeObjectURL(r)}catch(i){console.error("导出 JSON 出错：",i)}},async loadBlueprintByHashCode(t){if(t)try{const e=`${this.host}/download/${t}.json`,i=await fetch(e);if(!i.ok)throw new Error(`无法获取蓝图: ${i.status}`);const s=await i.json();return this.clearBlueprint(),this.importBluePrint(s),s}catch(e){throw console.error("加载蓝图出错：",e),e}},clearBlueprint(){this.rootGrid&&this.rootGrid.removeAll(),this.rootPipeGrid&&this.rootPipeGrid.removeAll(),this.gridWidgetElements=g({}),this.gridWidgets={},this.gridBelt2dElement=g({}),this.gridBelts2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({}))),this.gridPipe2dElement=g({}),this.gridPipes2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({}))),this.partsWidgetId={part0:new Set},this.partsBelts={part0:new Set},this.partsPipes={part0:new Set},this.parts=[{name:"part0",code:"",show:!0}],this.editPartChoose="part0"},loadLocalBlueprint(){if(localStorage.blueprint){this.clearBlueprint();try{const t=JSON.parse(localStorage.blueprint);return this.importBluePrint(t),t}catch(t){throw console.error("加载本地蓝图出错：",t),t}}return null}}}),T=S("sheng-machine-store",{state:()=>({rootStore:k()}),actions:{test(){},handleDialog(t,e){t.stopPropagation(),this.rootStore.recipeChooseId=e,this.rootStore.isRecipeChoose=!0,this.rootStore.rootGrid.enableMove(!1)},handleRightClick(t,e){t.preventDefault(),t.stopPropagation(),x.confirm("确定要删除这个机器吗？","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消"}).then(i=>{if(i){this.rootStore.rootGrid.removeWidget(this.rootStore.gridWidgetElements[e]);let s=this.rootStore.gridWidgets[e].part;this.rootStore.partsWidgetId[s].delete(e),delete this.rootStore.gridWidgetElements[e],delete this.rootStore.gridWidgets[e]}})}}});export{T as a,A as b,R as c,k as u};
