import{a9 as P,aa as u,ab as b,a5 as E}from"./vendor-CM7a-LQt.js";import{b as g,k as B,S as I}from"./utils-xEhagCug.js";import{t as x,r as S}from"./components-Cee0kNJq.js";const v=P("home",{state:()=>({userInfo:{isLoggedIn:!1,username:"",id:"",avatar:"user"},totalBlueprints:0,totalUsers:0,totalViews:0,totalDownloads:0,hotBlueprints:[],allBlueprints:[],discoverBlueprints:[],userBlueprintsPage:1,userBlueprintsLimit:10,userBlueprintsTotal:0,searchQuery:"",selectedArea:"",currentPage:1,pageSize:12,total:0,codeCountdown:0,sendCodeLoading:!1,loading:{stats:!1,blueprints:!1,discover:!1,user:!1},error:null}),actions:{setUserInfo(t){this.userInfo={isLoggedIn:!0,username:t.nickname||"",id:t.id||"",avatar:t.avatar||"user",role:"user"}},async register(t){try{return this.loading.user=!0,await g.register(t)}catch(e){throw this.error=e.message||"注册失败",e}finally{this.loading.user=!1}},async sendVerificationCode(t){try{if(!t)throw new Error("请输入邮箱");return this.sendCodeLoading=!0,this.error=null,await g.sendVerificationCode({email:t}),this.codeCountdown=60,this.startCountdown(),{success:!0,message:"验证码已发送，请查收"}}catch(e){throw this.error=e.message||"发送验证码失败",e}finally{this.sendCodeLoading=!1}},startCountdown(){this.countdownTimer&&clearInterval(this.countdownTimer),this.countdownTimer=setInterval(()=>{this.codeCountdown>0?this.codeCountdown--:(clearInterval(this.countdownTimer),this.countdownTimer=null)},1e3)},clearCountdown(){this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null,this.codeCountdown=0)},clearUserInfo(){this.userInfo={isLoggedIn:!1,username:"",id:"",avatar:"user"}},checkLoginStatus(){const t=localStorage.getItem("token");t&&(g.setToken(t),this.loadUserInfo())},async loadUserInfo(){try{this.loading.user=!0;const t=await g.getUserInfo();this.setUserInfo(t.data||{})}catch(t){console.error("加载用户信息失败:",t),localStorage.removeItem("token"),g.setToken(null),this.clearUserInfo()}finally{this.loading.user=!1}},async login(t){try{this.loading.user=!0;const e=await g.login(t);if(e.data.token)return g.setToken(e.data.token),localStorage.setItem("token",e.data.token),this.setUserInfo(e.data.user||{}),e.data}catch(e){throw this.error=e.message||"登录失败",e}finally{this.loading.user=!1}},logout(){g.setToken(null),localStorage.removeItem("token"),this.clearUserInfo()},async loadStats(){try{this.loading.stats=!0;const e=(await g.getHomepageData()).data||{};this.totalBlueprints=e.totalBlueprints||0,this.totalUsers=e.totalUsers||0,this.totalViews=e.totalViews||0,this.totalDownloads=e.totalDownloads||0,this.hotBlueprints=Array.isArray(e.hotBlueprints)?e.hotBlueprints.slice(0,7):[]}catch(t){this.error=t.message||"加载统计数据失败",console.error("加载统计数据失败:",t)}finally{this.loading.stats=!1}},async loadBlueprints(t={}){try{this.loading.blueprints=!0;const e=await g.getUserBlueprints({sortBy:t.sortBy||"createdAt",sortOrder:t.sortOrder||"desc",page:t.page||this.userBlueprintsPage,limit:t.limit||this.userBlueprintsLimit});this.allBlueprints=Array.isArray(e.data?.items)?e.data.items:[],this.userBlueprintsTotal=e.data?.total||0,this.userBlueprintsPage=e.data?.page||1,this.userBlueprintsLimit=e.data?.limit||10,this.totalBlueprints=this.allBlueprints.length,this.totalViews=Array.isArray(this.allBlueprints)?this.allBlueprints.reduce((s,r)=>s+(r.views||0),0):0,this.totalDownloads=Array.isArray(this.allBlueprints)?this.allBlueprints.reduce((s,r)=>s+(r.downloads||0),0):0}catch(e){this.error=e.message||"加载蓝图失败",this.allBlueprints=[],this.userBlueprintsTotal=0}finally{this.loading.blueprints=!1}},async refreshData(){await Promise.all([this.loadStats(),this.loadBlueprints()])},async loadDiscoverBlueprints(t=1,e={}){try{this.loading.discover=!0,this.error=null;const s={search:e.search||this.searchQuery,area:e.area||this.selectedArea,sortBy:"views",sortOrder:"desc",page:t,limit:e.limit||this.pageSize},r=await g.searchBlueprints(s);this.discoverBlueprints=Array.isArray(r.data?.items)?r.data.items:[],this.total=r.data?.total||0,this.currentPage=t,this.searchQuery=e.search||this.searchQuery,this.selectedArea=e.area||this.selectedArea}catch(s){this.error=s.message||"加载蓝图失败",console.error("加载发现页面蓝图失败:",s),this.discoverBlueprints=[],this.total=0}finally{this.loading.discover=!1}},setSearchFilters(t){t.search!==void 0&&(this.searchQuery=t.search),t.area!==void 0&&(this.selectedArea=t.area),t.page!==void 0&&(this.currentPage=t.page),t.pageSize!==void 0&&(this.pageSize=t.pageSize)},async getBlueprintById(t){return await g.getBlueprintById(t)}}}),C=P("sheng-root-store",{state:()=>({host:"https://api.t2blueprint.xyz",appContext:null,isBluePrintImport:!1,isRecipeChoose:!1,isWareHouseRecipeChoose:!1,isZomming:!1,isShowSupplierExtent:!1,isShowMachines:!0,isShowBelts:!0,isShowPipes:!0,isShowPipePort:!0,quickPlaceMode:"belt",keyboardCommand:null,selectSubMode:null,recipeChooseId:"",materialChooseId:"",toolbarMode:"default",beltSelect:"turn",editPartChoose:"part0",gridWidgetElements:u({}),gridWidgets:{},gridBelt2dElement:u({}),gridBelts2d:null,gridPipe2dElement:u({}),gridPipes2d:null,partsWidgetId:{part0:new Set},partsBelts:{part0:new Set},partsPipes:{part0:new Set},parts:[{name:"part0",code:"",show:!0}],rootGrid:null,gridEl:null,gridElCont:null,overlay:null,pipeGrid:null,rootPipeGrid:null,gridElContScale:1,defaultWidth:3017,defaultHeight:3017,defaultMaxWidth:3017,defaultMinWidth:1578,numColumn:72,gridOptions:{minRow:72,allowNewRow:!1,float:!0,acceptWidgets:function(t){return!0}},gridPipeOptions:{minRow:72,allowNewRow:!1,float:!0,acceptWidgets:function(t){return!1}},lastBaseNode:null,lastDir:null}),actions:{initGrid(t,e,s,r){this.initBelts2d(),this.appContext=r,this.gridEl=u(t),this.gridElCont=u(e),this.overlay=u(s),this.rootGrid=u(E.init(this.gridOptions,t)),this.rootGrid.column(this.numColumn),this.gridEl.style.width=`${this.defaultWidth}px`,this.gridEl.style.height=`${this.defaultHeight}px`,this.gridElContScale=1},initPipeGrid(t){this.pipeGrid=u(t),this.rootPipeGrid=u(E.init(this.gridPipeOptions,t)),this.rootPipeGrid.column(this.numColumn),this.pipeGrid.style.width=`${this.defaultWidth}px`,this.pipeGrid.style.height=`${this.defaultHeight}px`,this.gridPipes2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({})))},getPositionFromClick(t){let e=t.clientX,s=t.clientY;return this.rootGrid.getCellFromPixel({left:e,top:s},!0)},isCellEmpty(t){const{x:e,y:s}=this.getPositionFromClick(t);return this.isCellEmptyByPosition(e,s)},isCellEmptyByPosition(t,e){return this.rootGrid.isAreaEmpty(t,e,1,1)},isCellEmptyPipe(t){const{x:e,y:s}=this.getPositionFromClick(t);return this.isCellEmptyForPipe(e,s)},isCellEmptyForPipe(t,e){let s=this.rootGrid.isAreaEmpty(t,e,1,1),r=Object.keys(this.gridBelts2d[t][e]).length===0,a=Object.keys(this.gridPipes2d[t][e]).length===0;if(!a||!s&&r)return!1;if(!s&&!r||a)return!0},addNewPart(){const t={name:`part${this.parts.length}`,code:"",show:!0};this.partsBelts[t.name]=new Set,this.partsWidgetId[t.name]=new Set,this.partsPipes[t.name]=new Set,this.parts.push(t)},selectEditPart(t){this.editPartChoose=t},handlePartShowChange(t,e){const s=this.parts[t];this.showPartWidgets(s,e)},showPartWidgets(t,e){for(let s of this.partsWidgetId[t.name])this.gridWidgetElements[s].style.opacity=e?1:.2;for(let s of this.partsBelts[t.name])this.gridBelt2dElement[s].style.opacity=e?1:.2;for(let s of this.partsPipes[t.name])this.gridPipe2dElement[s].style.opacity=e?1:.2},deletePart(t){const e=this.parts[t];S.confirm("是否删除？模块中的机器和传送带会被并入part0","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消"}).then(s=>{if(s){for(let r of this.partsWidgetId[e.name])this.partsWidgetId.part0.add(r),this.gridWidgetElements[r].style.opacity=this.parts[0].show?1:.2;for(let r of this.partsBelts[e.name])this.partsBelts.part0.add(r),this.gridBelt2dElement[r].style.opacity=this.parts[0].show?1:.2;for(let r of this.partsPipes[e.name])this.partsPipes.part0.add(r),this.gridPipe2dElement[r].style.opacity=this.parts[0].show?1:.2;this.parts.splice(t,1),this.editPartChoose="part0"}})},copyEditCode(t){const e=this.parts[t];e&&(B.disable(),S.prompt("编辑模块代码","代码编辑",{confirmButtonText:"确定",cancelButtonText:"取消",defaultValue:e.code||""}).then(s=>{s!==null&&(this.parts[t].code=s)}).finally(()=>{B.enable()}))},handleScalingChange_(t){if(t.preventDefault(),t.stopPropagation(),this.toolbarMode==="select"||this.isRecipeChoose)return;this.isZomming||(this.isZomming=!0,this.rootGrid.setStatic(!0));const e=-t.deltaY*5e-4;this.gridElContScale=Math.max(.35,Math.min(2,this.gridElContScale+e)),B.updateScale(this.gridElContScale),this.gridEl.style.transform=`scale(${this.gridElContScale}) translate(100px, 100px)`,this.overlay.style.transform=`scale(${this.gridElContScale}) translate(100px, 100px)`,this.pipeGrid.style.transform=`scale(${this.gridElContScale}) translate(100px, 100px)`,clearTimeout(this._zoomEndTimer),this._zoomEndTimer=setTimeout(()=>{this.isZomming=!1,this.rootGrid.setStatic(!1)},120)},initBelts2d(){this.gridBelts2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({})))},deleteOneBelt(t){const e=this.gridBelt2dElement[`${t.x}-${t.y}`];if(e){this.rootGrid.removeWidget(e);let s=this.gridBelts2d[t.x][t.y].part;this.partsBelts[s].delete(`${t.x}-${t.y}`),this.gridBelts2d[t.x][t.y]={},delete this.gridBelt2dElement[`${t.x}-${t.y}`]}},deleteOnePipe(t){const e=this.gridPipe2dElement[`${t.x}-${t.y}`];if(e){this.rootPipeGrid.removeWidget(e);let s=this.gridPipes2d[t.x][t.y].part;this.partsPipes[s].delete(`${t.x}-${t.y}`),this.gridPipes2d[t.x][t.y]={},delete this.gridPipe2dElement[`${t.x}-${t.y}`]}},deleteSeriesBelt2d(t){const{startX:e,startY:s,endX:r,endY:a}=t,l=this.getPositionFromClick({clientX:e,clientY:s}),o=this.getPositionFromClick({clientX:r,clientY:a}),c=Math.min(l.x,o.x),p=Math.max(l.x,o.x),i=Math.min(l.y,o.y),h=Math.max(l.y,o.y);for(let n=c;n<=p;n++)if(!(n<0||n>=this.gridOptions.minRow))for(let d=i;d<=h;d++){if(d<0||d>=this.numColumn)continue;const m={x:n,y:d};this.deleteOneBelt(m)}},deleteSeriesPipe2d(t){const{startX:e,startY:s,endX:r,endY:a}=t,l=this.getPositionFromClick({clientX:e,clientY:s}),o=this.getPositionFromClick({clientX:r,clientY:a}),c=Math.min(l.x,o.x),p=Math.max(l.x,o.x),i=Math.min(l.y,o.y),h=Math.max(l.y,o.y);for(let n=c;n<=p;n++)if(!(n<0||n>=this.gridOptions.minRow))for(let d=i;d<=h;d++){if(d<0||d>=this.numColumn)continue;const m={x:n,y:d};this.deleteOnePipe(m)}},handleDialogRecipeClose(){this.rootGrid.enableMove(!0)},handleOverlayClick(t,e={}){const s=new MouseEvent("click",{clientX:t.clientX,clientY:t.clientY,bubbles:!0,cancelable:!0}),r=Object.assign(s,e);this.quickPlaceMode==="belt"&&this.gridEl.dispatchEvent(r),this.quickPlaceMode==="pipe"&&this.pipeGrid.dispatchEvent(r)},checkNodesCanMove(t,e,s,r){const{biasX:a,biasY:l}=s;return Object.entries(e).every(([c,p])=>{const h=p.el.gridstackNode,n=h.x+a,d=h.y+l;return t.isAreaEmpty(n,d,h.w,h.h)})?!0:(x.error(r),!1)},batchMovePipe(t,e){const{biasX:s,biasY:r}=e,a=this.rootPipeGrid.engine;a.batchUpdate(!0,!0),a.float=!1;const l=[];Object.entries(t).forEach(([o,c])=>{const p=c.el,i=p.gridstackNode,h=i.x+s,n=i.y+r,d=`${i.x}-${i.y}`;l.push({element:p,oldX:i.x,oldY:i.y,newX:h,newY:n,positionKey:d})}),l.forEach(o=>{a.moveNode(o.element.gridstackNode,o.newX,o.newY)}),a.batchUpdate(!1),a.float=!0,l.forEach(o=>{const c=`${o.oldX}-${o.oldY}`,p=`${o.newX}-${o.newY}`;this.gridPipes2d[o.newX][o.newY]=this.gridPipes2d[o.oldX][o.oldY],this.gridPipes2d[o.oldX][o.oldY]={},this.gridPipe2dElement[p]=this.gridPipe2dElement[c],delete this.gridPipe2dElement[c];const i=this.gridPipes2d[o.newX][o.newY].part;this.partsPipes[i].delete(c),this.partsPipes[i].add(p)})},batchMoveBelt(t,e){const{biasX:s,biasY:r}=e,a=this.rootGrid.engine,l=[];Object.entries(t).forEach(([o,c])=>{const p=c.el,i=p.gridstackNode,h=i.x+s,n=i.y+r,d=`${i.x}-${i.y}`;l.push({element:p,oldX:i.x,oldY:i.y,newX:h,newY:n,positionKey:d})}),a.batchUpdate(!0,!0),a.float=!1,l.forEach(o=>{a.moveNode(o.element.gridstackNode,o.newX,o.newY)}),a.batchUpdate(!1),a.float=!0,l.forEach(o=>{const c=`${o.oldX}-${o.oldY}`,p=`${o.newX}-${o.newY}`;this.gridBelts2d[o.newX][o.newY]=this.gridBelts2d[o.oldX][o.oldY],this.gridBelts2d[o.oldX][o.oldY]={},this.gridBelt2dElement[p]=this.gridBelt2dElement[c],delete this.gridBelt2dElement[c];const i=this.gridBelts2d[o.newX][o.newY].part;this.partsBelts[i].delete(c),this.partsBelts[i].add(p)})},batchMoveMachine(t,e){const{biasX:s,biasY:r}=e,a=this.rootGrid.engine;if(!Object.entries(t).every(([o,c])=>{const i=c.el.gridstackNode,h=i.x+s,n=i.y+r;return a.isAreaEmpty(h,n,i.w,i.h)})){x.error("移动目标位置已被占用");return}a.batchUpdate(!0,!0),a.float=!1,Object.entries(t).forEach(([o,c])=>{const i=c.el.gridstackNode,h=i.x+s,n=i.y+r;a.moveNode(i,h,n)}),a.batchUpdate(!1),a.float=!0},handleBluePrintImportDialog(){this.isBluePrintImport=!0},saveBluePrint(){let t={machine:null,belt:null,part:null},e=[],s=[],r=[],a={};const l=Object.entries(this.gridBelt2dElement),o=Object.entries(this.gridPipe2dElement),c=Object.entries(this.gridWidgetElements),p=Object.entries(this.gridWidgets);for(let i=0;i<c.length;i+=1){let[h,{rotate:n,recipe:d,part:m}]=p.at(i),[w,f]=c.at(i),y={id:h,machine_id:h.split("_")[0],recipe:d,rotate:n,x:f.gridstackNode.x,y:f.gridstackNode.y,w:f.gridstackNode.w,h:f.gridstackNode.h,part:m};e.push(y)}t.machine=e;for(let i=0;i<l.length;i+=1){let[h,n]=l.at(i),[d,m]=h.split("-"),{rotate:w,type:f}=this.gridBelts2d[Number(d)][Number(m)],y={id:n.gridstackNode.id,type:f,rotate:w,position:{x:Number(d),y:Number(m)}};s.push(y)}t.belt=s;for(let i=0;i<o.length;i+=1){let[h,n]=o.at(i),[d,m]=h.split("-"),{rotate:w,type:f}=this.gridPipes2d[Number(d)][Number(m)],y={id:n.gridstackNode.id,type:f,rotate:w,position:{x:Number(d),y:Number(m)}};r.push(y)}t.pipe=r,a.parts=this.parts,a.partsWidgetId={},a.partsBelts={},a.partsPipes={},a.editPartChoose=this.editPartChoose;for(let i of Object.keys(this.partsWidgetId)){let h=Array.from(this.partsWidgetId[i]),n=Array.from(this.partsBelts[i]),d=Array.from(this.partsPipes[i]);a.partsWidgetId[i]=h,a.partsBelts[i]=n,a.partsPipes[i]=d}return t.part=a,localStorage.removeItem("blueprint"),localStorage.blueprint=JSON.stringify(t),b.success({title:"成功",message:"蓝图保存成功"}),t},exportBluePrint(t,e="blueprint.json"){t=this.saveBluePrint();try{const s=JSON.stringify(t,null),r=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(r),l=document.createElement("a");l.href=a,l.download=e,l.click(),URL.revokeObjectURL(a)}catch(s){console.error("导出 JSON 出错：",s)}},clearBlueprint(){this.rootGrid&&this.rootGrid.removeAll(),this.rootPipeGrid&&this.rootPipeGrid.removeAll(),this.gridWidgetElements=u({}),this.gridWidgets={},this.gridBelt2dElement=u({}),this.gridBelts2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({}))),this.gridPipe2dElement=u({}),this.gridPipes2d=Array.from({length:this.gridOptions.minRow},()=>Array.from({length:this.numColumn},()=>({}))),this.partsWidgetId={part0:new Set},this.partsBelts={part0:new Set},this.partsPipes={part0:new Set},this.parts=[{name:"part0",code:"",show:!0}],this.editPartChoose="part0"},addBelt(t){const{position:e,type:s,rotate:r,id:a,craftElement:l}=t;this.partsBelts[this.editPartChoose].add(`${e.x}-${e.y}`),this.gridBelt2dElement[`${e.x}-${e.y}`]=l,this.gridBelts2d[e.x][e.y]={rotate:r,type:s,id:a,part:this.editPartChoose}},addPipe(t){const{position:e,type:s,rotate:r,id:a,craftElement:l}=t;this.partsPipes[this.editPartChoose].add(`${e.x}-${e.y}`),this.gridPipe2dElement[`${e.x}-${e.y}`]=l,this.gridPipes2d[e.x][e.y]={rotate:r,type:s,id:a,part:this.editPartChoose}},removeTargetPipe(t){const e=this.gridPipe2dElement[`${t.x}-${t.y}`];return e?(this.rootPipeGrid.removeWidget(e,!0),this.gridPipes2d[t.x][t.y]={},!0):!1},removeTargetBelt(t){const e=this.gridBelt2dElement[`${t.x}-${t.y}`];return e?(this.rootGrid.removeWidget(e,!0),this.gridBelts2d[t.x][t.y]={},!0):!1},addMachine(t){const{id:e,recipe:s,rotate:r,part:a,machineElement:l}=t;this.gridWidgetElements[e]=l,this.gridWidgets[e]={rotate:r,recipe:s,part:a}},initPart(t){if(t){if(this.parts=t.parts||[],this.partsWidgetId={},t.partsWidgetId)for(let e of Object.keys(t.partsWidgetId))this.partsWidgetId[e]=new Set(t.partsWidgetId[e]);if(this.partsBelts={},t.partsBelts)for(let e of Object.keys(t.partsBelts))this.partsBelts[e]=new Set(t.partsBelts[e]);if(this.partsPipes={},t.partsPipes)for(let e of Object.keys(t.partsPipes))this.partsPipes[e]=new Set(t.partsPipes[e]);this.editPartChoose=t.editPartChoose||"part0"}}}}),M=P("sheng-select-store",{state:()=>({rootStore:C(),selector:null,startX:null,startY:null,isStartSelect:!1,canSelect:!1,midDeleteData:null}),actions:{initSelector(t){this.selector=t},enableSelect(){this.canSelect=!0},disableSelect(){this.canSelect=!1},showSelector(){this.selector.style.opacity=1},hideSelector(){this.selector.style.opacity=0},confirmDelete(){this.rootStore.quickPlaceMode==="pipe"?this.rootStore.deleteSeriesPipe2d(this.midDeleteData):this.rootStore.deleteSeriesBelt2d(this.midDeleteData),this.hideSelectorAMenu()},handleSelectOver(){this.hideSelector(),this.isStartSelect=!1,this.selector.style.width="0px",this.selector.style.height="0px"},handleMouseDown(t){this.rootStore.toolbarMode=="select"&&this.canSelect&&(this.setPosition(t),this.showSelector(),this.isStartSelect=!0)},handleMouseMove(t){if(this.rootStore.toolbarMode!="select"||!this.isStartSelect)return;let e=Math.abs(this.startX-t.clientX),s=Math.abs(this.startY-t.clientY);this.selector.style.width=`${e}px`,this.selector.style.height=`${s}px`},handleMouseUp(t){if(this.rootStore.toolbarMode!="select"||!this.canSelect)return;let e=Math.abs(this.startX-t.clientX),s=Math.abs(this.startY-t.clientY)/2;this.endX=this.startX+e,this.endY=this.startY+s;const r={startCell:this.rootStore.getPositionFromClick({clientX:this.startX,clientY:this.startY}),endCell:this.rootStore.getPositionFromClick({clientX:this.startX+e,clientY:this.endY+s})};I.updateIndicatorContent(r),this.handleSelectOver()},setPosition(t){this.startX=t.clientX,this.startY=t.clientY,this.selector.style.top=`${t.clientY}px`,this.selector.style.left=`${t.clientX}px`}}}),$=P("sheng-machine-store",{state:()=>({rootStore:C()}),actions:{test(){},handleDialog(t,e){t.stopPropagation(),this.rootStore.recipeChooseId=e,this.rootStore.isRecipeChoose=!0,this.rootStore.rootGrid.enableMove(!1)},handleRightClick(t,e){t.preventDefault(),t.stopPropagation(),S.confirm("确定要删除这个机器吗？","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消"}).then(s=>{if(s){this.rootStore.rootGrid.removeWidget(this.rootStore.gridWidgetElements[e]);let r=this.rootStore.gridWidgets[e].part;this.rootStore.partsWidgetId[r].delete(e),delete this.rootStore.gridWidgetElements[e],delete this.rootStore.gridWidgets[e]}})}}});export{$ as a,v as b,M as c,C as u};
